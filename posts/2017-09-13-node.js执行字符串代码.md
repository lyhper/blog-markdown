---
title: node.jsæ‰§è¡Œå­—ç¬¦ä¸²ä»£ç 
date: 2017-09-13
categories: Nodejs
---

## å‰è¨€
æåˆ°jså­—ç¬¦ä¸²ä»£ç ï¼Œæœ€å®¹æ˜“æƒ³åˆ°çš„å°±æ˜¯evalæ–¹æ³•ï¼Œæ¯”å¦‚eval('console.log(1)')ã€‚ä½†æ˜¯åœ¨nodeç«¯ï¼Œevalæ–¹æ³•å¹¶ä¸èƒ½å¾ˆå¥½çš„ä½¿ç”¨ï¼Œå› ä¸ºåœ¨å®ƒçš„ä½œç”¨åŸŸé‡Œå’ŒåŸç”Ÿæ¨¡å—çš„è¡Œä¸ºæœ‰ä¸€å®šçš„å·®å¼‚ï¼Œæ¯”å¦‚ä¸èƒ½å¦‚åŸç”Ÿæ¨¡å—ä¸€æ ·è®¿é—®åˆ°exportså˜é‡ï¼›å¹¶ä¸”ï¼Œå®ƒä¸èƒ½å¤Ÿæ¨¡æ‹Ÿæ¨¡å—çš„è¡Œä¸ºã€‚è€Œmoduleæ¨¡å—å°±èƒ½å¾ˆå¥½çš„è§£å†³è¿™ä¸€é—®é¢˜ã€‚

## moduleå˜é‡çš„ä»‹ç»
åœ¨ä¸€ä¸ªæ¨¡å—å†…éƒ¨ï¼Œmoduleå˜é‡æ˜¯å½“å‰æ¨¡å—çš„å¼•ç”¨ã€‚åœ¨æ§åˆ¶å°æ‰“å°å‡ºæ¥ï¼Œmoduleå˜é‡å«æœ‰å¦‚ä¸‹å±æ€§ï¼š

![moduleå˜é‡](https://raw.githubusercontent.com/lyhper/blog-markdown/master/img/module.png)

- idè¡¨ç¤ºå½“å‰æ¨¡å—çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼›
- exportsè¡¨ç¤ºå½“å‰æ¨¡å—è¾“å‡ºçš„å†…å®¹ï¼›
- parentæ˜¯ç¬¬ä¸€ä¸ªå¼•ç”¨å½“å‰æ¨¡å—çš„æ¨¡å—ï¼›
- filenameå°±æ˜¯å½“å‰æ¨¡å—çš„æ–‡ä»¶å;
- loadedè¡¨ç¤ºæ˜¯å¦åŠ è½½å®Œæˆ;
- childrenè¡¨ç¤ºå½“å‰æ¨¡å—å¼•ç”¨è¿‡çš„æ¨¡å—ï¼›
- pathsè¡¨ç¤ºå½“å‰æ¨¡å—çš„æŸ¥æ‰¾è·¯å¾„æ•°ç»„

## moduleæ¨¡å—æ–¹æ³•ç®€ä»‹
moduleæ„é€ å‡½æ•°
```javascript
function Module(id, parent) {
  this.id = id;
  this.exports = {};
  this.parent = parent;
  updateChildren(parent, this, false);
  this.filename = null;
  this.loaded = false;
  this.children = [];
}
```
idè¡¨ç¤ºæ¨¡å—çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œparentè¡¨ç¤ºç¬¬ä¸€ä¸ªå¼•ç”¨æ­¤æ¨¡å—çš„æ¨¡å—

_compileæ–¹æ³•
```javascript
// Run the file contents in the correct scope or sandbox. Expose
// the correct helper variables (require, module, exports) to
// the file.
// Returns exception, if any.
Module.prototype._compile = function(content, filename) {

  content = internalModule.stripShebang(content);

  // create wrapper function
  var wrapper = Module.wrap(content);

  var compiledWrapper = vm.runInThisContext(wrapper, {
    filename: filename,
    lineOffset: 0,
    displayErrors: true
  });

  var inspectorWrapper = null;
  if (process._breakFirstLine && process._eval == null) {
    if (!resolvedArgv) {
      // we enter the repl if we're not given a filename argument.
      if (process.argv[1]) {
        resolvedArgv = Module._resolveFilename(process.argv[1], null, false);
      } else {
        resolvedArgv = 'repl';
      }
    }

    // Set breakpoint on module start
    if (filename === resolvedArgv) {
      delete process._breakFirstLine;
      inspectorWrapper = process.binding('inspector').callAndPauseOnStart;
      if (!inspectorWrapper) {
        const Debug = vm.runInDebugContext('Debug');
        Debug.setBreakPoint(compiledWrapper, 0, 0);
      }
    }
  }
  var dirname = path.dirname(filename);
  var require = internalModule.makeRequireFunction(this);
  var depth = internalModule.requireDepth;
  if (depth === 0) stat.cache = new Map();
  var result;
  if (inspectorWrapper) {
    result = inspectorWrapper(compiledWrapper, this.exports, this.exports,
                              require, this, filename, dirname);
  } else {
    result = compiledWrapper.call(this.exports, this.exports, require, this,
                                  filename, dirname);
  }
  if (depth === 0) stat.cache = null;
  return result;
};

```
contentè¡¨ç¤ºè¦æ‰§è¡Œçš„jsä»£ç ï¼Œfilenameè¡¨ç¤ºæ–‡ä»¶åã€‚è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨å°±æ˜¯åœ¨æ¨¡å—çš„ä½œç”¨åŸŸå†…æ‰§è¡Œjsä»£ç å­—ç¬¦ä¸²ï¼Œå¹¶æš´éœ²å‡ºå“åº”çš„å˜é‡

## ä¸¾ä¸ªğŸŒ°
è·å–moduleæ„é€ å‡½æ•°æœ‰ä¸¤ç§åŠæ³•ï¼š
- const Module = require('module')
- const Module = module.constructor

è¿™é‡Œé‡‡ç”¨ç¬¬ä¸€ç§æ–¹æ³•
```javascript
const Module = require('module')

const myModule = new Module('my-module')
const jsCode = 'console.log(1);module.exports = 1'
myModule._compile(jsCode, 'my-module')

console.log(myModule.exports) //æˆ‘çš„æ¨¡å—æš´éœ²å‡ºçš„å†…å®¹
```

## å‚è€ƒæ–‡æ¡£
- [nodejså®˜æ–¹æ–‡æ¡£](https://nodejs.org/dist/latest-v7.x/docs/api/modules.html)
- [moduleæºä»£ç ](https://github.com/nodejs/node/blob/master/lib/module.js)